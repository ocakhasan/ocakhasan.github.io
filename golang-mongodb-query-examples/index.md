# Golang & MongoDB Query Cheat Sheet


# MongoDB & Golang Query Examples - Cheat Sheet

This cheat sheet should help you about the [MongoDB](https://www.mongodb.com/) queries with Golang. We will start with some basic examples to more complex queries with Go Programming Language. 

The examples are written with Go 1.19 and [go.mongodb.org/mongo-driver/mongo](https://github.com/mongodb/mongo-go-driver).

## Table Of Contents

[Connecting to MongoDB](#how-to-connect-to-mongodb-with-golang)

[Inserting A Document to MongoDB](#inserting-a-document-to-mongodb-with-golang)

[Writing Multiple Documents To MongoDB](#writing-multiple-documents-to-mongodb-with-golang)

[Finding Single Document From MongoDB](#finding-single-document-from-mongodb-with-golang)

[Finding All Documents From MongoDB](#finding-all-documents-from-mongodb-with-golang)

[Updating Document(s) From MongoDB](#update-single-document-in-mongodb-with-golang)

[Deleting Document(s) From MongoDB](#delete-documents-from-mongodb-with-golang)




## How to Connect to MongoDB with Golang

Connecting to MongoDB is fairly simple, you just connect the uri generated by the MongoDB. 

Then we can use the [client.Database()](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Client.Database) function to make sure that we are connecting to the correct database. 

```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

	// disconnect the mongo client when main is completed
	defer func() {
		if err = client.Disconnect(ctx); err != nil {
			panic(err)
		}
	}()
}
```

To really make sure that we are connected to the correct database, we can use the `Ping` method. 

```go
ctx, cancel = context.WithTimeout(context.Background(), 2*time.Second)
defer cancel()
err = client.Ping(ctx, readpref.Primary())
```

## Inserting A Document to MongoDB with Golang

To insert a document to MongoDB, we can use the [bson.D](https://pkg.go.dev/go.mongodb.org/mongo-driver/bson#D) provided by the MongoDB. But to make the operations more simple and more realistic to real world applications, we will use `structs` with `bson` tags. 

The model we are using is
```go
type Car struct {
	Id    primitive.ObjectID `bson:"_id"`
	Brand string             `bson:"brand"`
	Model string             `bson:"model"`
	Year  int                `bson:"year"`
}
```

Then we can simply use the [InsertOne()](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.InsertOne) method to insert a document to MongoDB. 

```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

type Car struct {
	Id        primitive.ObjectID `bson:"_id"`
    CreatedAt time.Time          `bson:"createdAt"`
	Brand     string             `bson:"brand"`
	Model     string             `bson:"model"`
	Year      int                `bson:"year"`
}

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

	exampleData := Car{
		Id:    primitive.NewObjectID(),
        CreatedAt: time.Now().UTC(),
		Brand: "Mercedes",
		Model: "G-360",
		Year:  2002,
	}

	res, err := db.Collection("cars").InsertOne(context.Background(), exampleData)
	if err != nil {
		log.Fatal(err)
	}

	// inserted id is ObjectID("639b62ae2518fbd9315e405d")
	log.Printf("inserted id is %v", res.InsertedID)
}
```

## Writing Multiple Documents To MongoDB with Golang

We can use the [InsertMany()](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.InsertMany) method of the [Collection](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection) object. However, the `InsertMany()` requires an `[]interface{}` to work on.

```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

type Car struct {
	Id        primitive.ObjectID `bson:"_id"`
    CreatedAt time.Time          `bson:"createdAt"`
	Brand     string             `bson:"brand"`
	Model     string             `bson:"model"`
	Year      int                `bson:"year"`
}

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

	var data []interface{}
	data = append(data, Car{
		Id:    primitive.NewObjectID(),
        CreatedAt: time.Now().UTC(),
		Brand: "Toyota",
		Model: "Corolla",
		Year:  2008,
	})
	data = append(data, Car{
		Id:    primitive.NewObjectID(),
        CreatedAt: time.Now().UTC(),
		Brand: "Ford",
		Model: "Focus",
		Year:  2021,
	})

	res, err := db.Collection("cars").InsertMany(context.Background(), data)
	if err != nil {
		log.Fatal(err)
	}

	// 2 documents inserted
	log.Printf("%v documents inserted", len(res.InsertedIDs))
}
```

## Finding Single Document From MongoDB with Golang

To find a single document with a condition, we can use the [FindOne()](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.FindOne) method of `*Collection` object. 


```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

type Car struct {
	Id        primitive.ObjectID `bson:"_id"`
    CreatedAt time.Time          `bson:"createdAt"`
	Brand     string             `bson:"brand"`
	Model     string             `bson:"model"`
	Year      int                `bson:"year"`
}

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

    condition := bson.M{}
    cur, err := db.Collection("cars").FindOne(context.Background(), condition)
	if err != nil {
		log.Fatal(err)
	}

	var data []Car
	if err := cur.All(context.Background(), &data); err != nil {
		log.Fatal(err)
	}

	// now we can use the data array, which contains all of the documents
	for _, car := range data {
		log.Printf("the brand is %v\n", car.Brand)
	}

}
```

### Fetch the Lastly Created Document
We can also pass [mongo.Options](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo/options#FindOneOptions) to the `Find()` operation. Let's say we want to fetch the lastly inserted document. 

- we need to sort by the `createdAt` field 
- it should be descending, that's why we made the sort value as `-1`.
  
```go
var opts = options.FindOne().SetSort(bson.M{
    "createdAt": -1,
})
res := db.Collection("cars").FindOne(context.Background(), bson.M{}, opts)
if res.Err() != nil {
    log.Fatal(err)
}
```

## Finding All Documents From MongoDB with Golang

To find the all documents in a collection, we can use the [Find()](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection.Find) method of `*Collection` object. In the below example, we did not specify any condition, which means that return all of the documents in the database.

```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

type Car struct {
	Id        primitive.ObjectID `bson:"_id"`
    CreatedAt time.Time          `bson:"createdAt"`
	Brand     string             `bson:"brand"`
	Model     string             `bson:"model"`
	Year      int                `bson:"year"`
}

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

    condition := bson.M{}
    cur, err := db.Collection("cars").Find(context.Background(), condition)
	if err != nil {
		log.Fatal(err)
	}

	var data []Car
	if err := cur.All(context.Background(), &data); err != nil {
		log.Fatal(err)
	}

	// now we can use the data array, which contains all of the documents
	for _, car := range data {
		log.Printf("the brand is %v\n", car.Brand)
	}

}
```

### Finding Many Documents With Condition

If we would like to return the cars where the `brand` is *Toyota*, then we can change the `condition` variable as
```go
condition := bson.M{
    "brand": "Toyota"
}
```

### Use Projection in Find Operations

If you want to use projection in `Find()` operation, we can use the `mongo.Options` for that. Let's say we would like to return 2 fields
1. return the brand of the car.
2. return a boolean field to check if the car is new
   1. if the production year of the car is 2022, it is new
   2. else, it is old.


[SetProjection()](https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo/options#FindOptions.SetProjection) sets the value for the projection field.

```go
var opts = options.Find().SetProjection(
		bson.M{
			"brand": 1,
			"isNew": bson.M{
				"$cond": bson.M{
					"if": bson.M{"$gte": bson.A{"$year", 2022}}, 
					"then": true, 
					"else": false},
			},
		})
cur, err := db.Collection("cars").Find(context.Background(), bson.M{}, opts)
```

More will come, so please stay tuned!

### Update Single Document in MongoDB With Golang

To update a single document, we should use the `FindOneAndUpdate()` or `UpdateOne()` operations. For this blog, we will use the `FindOneAndUpdate()` operation.

```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

	filter := bson.M{
		"brand": "Toyota",
		"model": "Corolla",
	}

	update := bson.M{
		"year": 2022,
	}

	res := db.Collection("cars").FindOneAndUpdate(context.Background(), filter, update)

	if res.Err() != nil {
		log.Fatal(err)
	}

	// operation successful
}
```

#### How to return the updated document in MongoDB?

We can use `mongo.Options` package to do that. We should set the return document option to after.

```go
opts := options.FindOneAndUpdate().SetReturnDocument(options.After)

res := db.Collection("cars").FindOneAndUpdate(context.Background(), filter, update, opts)

// we can use the updated car document
var updatedData Car

if err := res.Decode(&updatedData); err != nil {
	log.Fatal(err)
}
```

### Delete Document(s) from MongoDB with Golang

To delete a document we can use `DeleteOne()` method of the `*Collection` object. 

To delete many documents, we can use the `DeleteMany()` method of the `*Collection`

```go
package main

import (
	"context"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	client, err := mongo.Connect(ctx, options.Client().ApplyURI("mongodb://localhost:27017"))
	if err != nil {
		log.Fatal(err)
	}

	db := client.Database("testdb")

	filter := bson.M{
		"brand": "Toyota",
		"model": "Corolla",
	}

	// for single document
	res, err := db.Collection("cars").DeleteMany(context.Background(), filter)

	if err != nil {
		log.Fatal(err)
	}

	// 1 document is deleted.
	log.Printf("%v document is deleted", res.DeletedCount)
}

```

More will come, so please stay tuned!
